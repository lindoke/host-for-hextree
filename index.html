<script>
   let ports = [];
   let portCount = 0;
   const messageContainer = document.getElementById("message-container");
   const sendMessageButton = document.getElementById("send-message");
   
   window.addEventListener("message", function (event) {
       if (!event.ports || event.ports.length === 0) return;
       const port = event.ports[0];
       if (ports.includes(port)) return;
   
       ports.push(port);
       const portIndex = portCount++;
   
       function postMessageToApp(msg) {
           const msgDiv = document.createElement("div");
           msgDiv.textContent = `[web] ${msg}`;
           messageContainer.appendChild(msgDiv);
           port.postMessage(msg);
       }
   
       port.onmessage = function(event) {
           const msgDiv = document.createElement("div");
           try {
               msgDiv.textContent = `[app] ${JSON.stringify(JSON.parse(event.data), null, 2)}`;
           } catch (e) {
               msgDiv.textContent = `[app] ${event.data}`;
           }
           messageContainer.appendChild(msgDiv);
       };
   
       postMessageToApp(JSON.stringify({ message: "init_complete" }));
       setTimeout(() => postMessageToApp(JSON.stringify({ message: "success" })), 3000);
   });
   
   sendMessageButton.addEventListener("click", () => {
       window.postMessage({ message: "test" }, "*");
   });
</script>
